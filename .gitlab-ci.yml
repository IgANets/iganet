before_script:
   - apt-get update -y
   - apt-get install build-essential doxygen locales unzip wget zlib1g-dev -y
   - wget https://github.com/Kitware/CMake/releases/download/v3.24.3/cmake-3.24.3-linux-x86_64.tar.gz
   - tar xvzf cmake-3.24.3-linux-x86_64.tar.gz -C /
   - rm -f cmake-3.24.3-linux-x86_64.tar.gz
   - wget https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-1.13.0%2Bcpu.zip -O libtorch.zip
   - unzip libtorch.zip -d /
   - rm -f libtorch.zip
   - export PATH=$PATH:/cmake-3.24.3-linux-x86_64/bin
   - export LANG=en_US.UTF-8
   - export LC_ALL=en_US.UTF-8

stages:
  - build

#
# Create Doxygen documentation
#
pages:
  stage: build
  image: ubuntu:22.04
  script:
    - mkdir -p build
    - cd build
    - CC=gcc CXX=g++ cmake .. -DIGANET_BUILD_DOCS=ON -DTorch_DIR=/libtorch/share/cmake/Torch
    - make Doxygen
    - mv docs/doxygen/html ../public
    - mv docs/doxygen/*.xml ../public
  only:
    changes:
      - CMakeLists.txt
      - cmake/*
      - docs/*
      - include/*
      - examples/*
      - perftests/*
      - pybind11/*
      - unittests/*
  artifacts:
    paths:
      - public

#
# Compile and run unittests with GNU compiler collection
#
unittests-gcc:
  stage: build
  image: ubuntu:22.04
  script:
    - mkdir -p build
    - cd build
    - CC=gcc CXX=g++  cmake .. -DIGANET_BUILD_UNITTESTS=ON -DTorch_DIR=/libtorch/share/cmake/Torch
    - make
    - make test
  only:
    changes:
      - CMakeLists.txt
      - cmake/*
      - include/*
      - examples/*
      - perftests/*
      - pybind11/*
      - unittests/*
