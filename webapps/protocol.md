# WebApp protocol

_Version: 0.4 (23-03-2023)_

All WebApps implement the following [WebSocket](https://en.wikipedia.org/wiki/WebSocket)-based client-server protocol. All communication is initiated by the client and responded by the server. Only broadcasts are initiated by the server and responded by all clients, e.g., when a client request leads to a state change of the server, then an update is broadcasted to all clients connected to the same session.

The format of the [JSON](https://en.wikipedia.org/wiki/JSON)-based protocol is as follows:

_Client request_

```
{
    "id"      : <UUID>
    "request" : <command>[/<session-id>][/<model-id>][/<attribute>]
  [ "data"    : {...} ]
}
```

_Server response_

```
{
    "request" : <UUID>
    "status"  : <integer>
  [ "reason"  : <string> ]
  [ "data"    : {...} ]
}
```

*   `UUID` is chosen by the client for each new request and copied by the server in the reply. 

*   `request` encodes the actual `command`, optionally followed by the `session-id`, the `model-id`, and an `attribute`

*   `status` is an integer from the following list of predefined integers:
    - 0 : `SUCCESS`
    - 1 : `ERROR`

*   `reason` is an optional string that contains human-readable information about a failed request. Successful requests with `status : 0` will not contain a `reason` field

*    `data` is an optional request/response-dependent payload

In what follows, only the non-generic parts of the protocol are specified in more detail. 

## 1 Session commands

### 1.1 Get a list of all active sessions

   _Client request_
   ```
   "request" : get
   ```

   _Server response_
   ```
   "status"  : 0
   "data"    : { "ids" : [<comma-separated list of session ids>] }
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 1.2 Create a new session

   _Client request_
   ```
   "request" : create/session
   ```

   _Server response_
   ```
   "status"  : 0
   "data"    : { "id" : session-id,
                 "models" : [<comma-separated list of models>] }
   ```
   -   The `session-id` is generated by the server and serves as authentification mechanism.
   -   The `models` list describes the models supported by the server. Each list entry has the form
       ```
       { "name"        : <string>,
         "description" : <string>,
         "options"     : [<comma-separated list of options>] }
       ```
       whereby each entry in the `options` list has the form
       ```
       { "name"        : <string>,
         "description" : <string>,
         "type"        : <type descriptor>,
         "value"       : <initial value>,
         "uiid"        : <integer specifying the position in the UI> }
       ```

       _Example:_
       ```
       { "name"        : "ncoeffs",
         "description" : "Number of coefficients",
         "type"        : [int,int],
         "value"       : [5,5],
         "uiid"        : 0 }
       ```

       This information can be used to generate UI elements dynamically based on the capabilities of the server. The model's `name` must be used for creating a specific type. More details are given in Section 3.

   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 1.3 Remove an existing session

   _Client request_
   ```
   "request" : remove/<session-id>
   ```

   _Server response_
   ```
   "status"  : 0
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 1.4 Connect to an existing session

   _Client request_
   ```
   "request" : connect/<session-id>
   ```

   _Server response_
   ```
   "status"  : 0
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 1.3 Disconnect from an existing session

   _Client request_
   ```
   "request" : disconnect/<session-id>
   ```

   _Server response_
   ```
   "status"  : 0
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```


## 2 Model commands

### 2.1 Get a list of all models of a specific session

   _Client request_
   ```
   "request" : get/<session-id>
   ```

   _Server response_
   ```
   "status"  : 0
   "data"    : { "ids" : [<comma-separated list of model ids>] }
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 2.2 Create a new model

   _Client request_
   ```
   "request" : create/<session-id>/<model-type>
   "data"    : {...}
   ```

   The list of supported models is sent by the server upon creating a new session or connecting to an existing session. For details see Sections __1.2 Create a new session__ and __3 Models__.

   _Server response_
   ```
   "status"  : 0
   "data"    : { "id" : model-id }
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 2.3 Remove an existing model

   _Client request_
   ```
   "request" : remove/<session-id>/<model-id>
   ```

   _Server response_
   ```
   "status"  : 0
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 2.4 Get all attributes of a specific model

   _Client request_
   ```
   "request" : get/<session-id>/<model-id>
   ```

   The attributes for the different models are given in Section __3 Models__

   _Server response_
   ```
   "status"  : 0
   "data"    : {...}
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 2.5 Get a specific attribute of a specific model

   _Client request_
   ```
   "request" : get/<session-id>/<model-id>/<attribute>
   ```

   The attributes for the different models are given in Section __3 Models__

   _Server response_
   ```
   "status"  : 0
   "data"    : {...}
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```
   The `data` will be formatted in the same format as in the _get all attributes_ case.

### 2.6 Update a specific attribute of a specific model

   _Client request_
   ```
   "request" : put/<session-id>/<model-id>/<attribute>
   ```

   The updatable attributes for the different models are given in Section __3 Models__

   _Server response_
   ```
   "status"  : 0
   "data"    : {...}
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 2.7 Evaluate a specific model

   _Client request_
   ```
   "request" : eval/<session-id>/<model-id>
   "data"    : {
                 "resolution" : [<list of integers]
               }
   ```
   If the optional `data` and `resolution` are not present, the default resolution is 25 in each parametric dimension.

   _Server response_
   ```
   "status"  : 0
   "data" : { 
              "values" : [<list of floats in lexicographical order>]
            }
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 2.8 Refine a specific model

   _Client request_
   ```
   "request" : refine/<session-id>/<model-id>
   "data"    : {
                 [ "numRefine" : <integer> (default value is 1) ]
                 [ "dim"       : <integer> (default value is -1) ]
               }
   ```
   If no `data` field is provided the default values are adopted.

   _Server response_
   ```
   "status"  : 0
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

## 3 Models

### 3.1 Type descriptor

The `type descriptor` must be one of the following

| `type`        | description  | value format example |
|--------------:|:-------------|:---------------------|
| `int`         | integer value| `"value" : 5` or     |
||| `"value" : [5,5]`  |
| `float`       | float value  | `"value" : 5.0` or  |
||| `"value" : [5.0,5.0]` |
| `string`      | string value | `"value" : "string"` or |
||| `"value" : ["string1","string2"]` |
| `list`    | can select no, one or multiple options | `"value" : { "option0", "option1" }`|
| `select` | must select one option  | `"value" : { "option0", "option1" }`|

Types `list` and `select` correspond to enumerates with the mapping `option0 -> 0`, `option1 -> 1` etcetera. It is therefore expected that if, say, `option1` is chosen in a `select` type, the UI sends the value `1` in the next request. Similarly, if, say, `options0` and `options1` are chosen in a `list` type, the UI sends the value `[0,1]` in the next request. 

### 3.2 B-spline models

The following B-spline models are implemented:
-    `BSplineCurve`
-    `BSplineSurface`
-    `BSplineVolume`.

#### 3.2.1 B-spline model options
```
"data" : { 
            "degree"     : <integer> valid values are 
                                     0 constant,
                                     1 linear (default),
                                     2 quadratic,
                                     3 cubic,
                                     4 quartic,
                                     5 quintic
            "init"       : <integer> valid values are 
                                     0 zeros,
                                     1 ones,
                                     2 linear (default),
                                     3 random,
                                     4 Greville
            "ncoeffs"    : [<comma-separated list of integers>]
                                     [4,...] (default)
            "nonuniform" : <bool>    valid values are
                                     0 uniform (default),
                                     1 nonuniform
         }
```

#### 3.2.2 B-spline model attributes
```
"data" : { 
            "geoDim"  : <integer>    valid values are 
                                     1 univariate,
                                     2 bivariate,
                                     3 trivariate,
                                     4 quadrupelvariate
            "parDim"  : <integer>    valid values are
                                     1 univariate,
                                     2 bivariate,
                                     3 trivariate,
                                     4 quadrupelvariate 
            "degrees" : [<comma-separated list of integers>]
            "ncoeffs" : [<comma-separated list of integers>]
            "nknots"  : [<comma-separated list of integers>]
            "coeffs"  : [[comma-separated list of lists of floats]]
            "knots"   : [[comma-separated list of lists of floats]]
         }
```

-   The attribute `coeffs` is stored as a list of lists with the inner list containing all coefficients in lexicographical order(i.e. with the first parametric dimension $\xi_1$ running quickest and the last parametric dimension $\xi_{\text{par}_\text{dim}}$ running slowest) and the outer list containing the coefficients of the different geometric dimensions. 
       
    __Example:__
    ```
    coeffs = [[x_1_1, x_2_1, ..., x_ncoeffs(1)_ncoeffs(2)], ...,
              [z_1_1, z_1_2, ..., z_ncoeffs(1)_ncoeffs(2)]]
    ```
    for a bivariate parametrization with coefficients in $\mathbb{R}^3$.

    Currently, the float values are stored as plain JSON string but it is planned to change to binary base64 encoding in the future.

-   The attribute `coeffs` can be modifief by the `put` command.

    __Example:__
    ```
    "request" : put/<session-id>/<model-id>/coeffs
    "data"    : {
                  "indices" : [0, 6, 9],
                  "coeffs"  : [[0.5, 0.2], [0.3, 0.6], [0.9, 1.2]]
                }
    ```
    This will update the coordinates of the two-dimensional coefficients with global indices `0`, `6`, and `9` to the values `[0.5, 0.2]`, `[0.3, 0.6]`, and `[0.9, 1.2]`. It is not assumed that the indices and coordinates are numbered.

-   The attribute `knots` is stored as a list of lists with the inner list containing the univariate knot vectors and the outer list containing the different parametric dimensions. 
       
    __Example:__
    ```
    knots = [[k1_1, ..., k1_nknots[0]], ..., 
             [kparDim_1, ..., kparDim_nknots[parDim]]]
    ```

    Currently, the float values are stored as plain JSON string but it is planned to change to binary base64 encoding in the future.

---

1. load serialized model from file on client side
2. global translate and rotate parameter
