# WebApp protocol

_Version: 0.3 (12-03-2023)_

All WebApps implement the following [WebSocket](https://en.wikipedia.org/wiki/WebSocket)-based client-server protocol. All communication is initiated by the client and responded by the server. Only broadcasts are initiated by the server and responded by all clients, e.g., when a client request leads to a state change of the server, then an update is broadcasted to all clients connected to the same session.

The format of the [JSON](https://en.wikipedia.org/wiki/JSON)-based protocol is as follows:

_Client request_

```
{
    "id"      : <UUID>
    "request" : <command>[/<session-id>][/<model-id>][/<attribute>]
  [ "data"    : {...} ]
}
```

_Server response_

```
{
    "request" : <UUID>
    "status"  : <integer>
  [ "reason"  : <string> ]
  [ "data"    : {...} ]
}
```

*   `UUID` is chosen by the client for each new request and copied by the server in the reply. 

*   `request` encodes the actual `command`, optionally followed by the `session-id`, the `model-id`, and an `attribute`

*   `status` is an integer from the following list of predefined integers:
    - 0 : `SUCCESS`
    - 1 : `ERROR`

*   `reason` is an optional string that contains human-readable information about a failed request. Successful requests with `status : 0` will not contain a `reason` field

*    `data` is an optional request/response-dependent payload

In what follows, only the non-generic parts of the protocol are specified in more detail. 

## 1 Session commands

### 1.1 Get a list of all active sessions

   _Client request_
   ```
   "request" : get
   ```

   _Server response_
   ```
   "status"  : 0
   "data"    : { "ids" : [<comma-separated list of session ids>] }
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 1.2 Create a new session

   _Client request_
   ```
   "request" : create/session
   ```

   _Server response_
   ```
   "status"  : 0
   "data"    : { "id" : session-id,
                 "models" : [<comma-separated list of models>] }
   ```
   -   The `session-id` is generated by the server and serves as authentification mechanism for (re-)connecting to or removing a running session.
   -   The `models` list describes the list of models supported by the server. Each list entry has the form
       ```
       { "name"        : <string>,
         "description" : <string>,
         "options"     : [<comma-separated list of options>] }
       ```
       whereby `options` is a list of key-value pairs, e.g.,
       ```
         "options"     : [ { "ncoeffs" : "int, int" } ]
       ```
       meaning that the respective model accepts an array of two integer values as `ncoeffs`. This information can be used to generate UI elements dynamically based on the capabilities of the server. The model's `name` must be used for creating a specific type.

   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 1.3 Remove an existing session

   _Client request_
   ```
   "request" : remove/<session-id>
   ```

   _Server response_
   ```
   "status"  : 0
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 1.4 Connect to an existing session

   _Client request_
   ```
   "request" : connect/<session-id>
   ```

   _Server response_
   ```
   "status"  : 0
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 1.3 Disconnect from an existing session

   _Client request_
   ```
   "request" : disconnect/<session-id>
   ```

   _Server response_
   ```
   "status"  : 0
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```


## 2 Model commands

### 2.1 Get a list of all models of a specific session

   _Client request_
   ```
   "request" : get/<session-id>
   ```

   _Server response_
   ```
   "status"  : 0
   "data"    : { "ids" : [<comma-separated list of model ids>] }
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 2.2 Create a new model

   _Client request_
   ```
   "request" : create/<session-id>/<model-type>
   "data"    : {...}
   ```

   The list of supported models is sent by the server upon creating a new session or connecting to an existing session. For details see Section `1.2 Create a new session`.

   _Server response_
   ```
   "status"  : 0
   "data"    : { "id" : model-id }
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

## 2.3 Remove an existing model

   _Client request_
   ```
   "request" : remove/<session-id>/<model-id>
   ```

   _Server response_
   ```
   "status"  : 0
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 2.4 Get all attributes of a specific model

   _Client request_
   ```
   "request" : get/<session-id>/<model-id>
   ```

   _Server response_
   ```
   "status"  : 0
   "data"    : {...}
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

   Supported __model-types__:

   -   `uniformBSpline` and `nonuniformBSpline`
       ```
       "data" : { 
                  "geoDim"  : <integer> valid values are 1,2,3,4
                  "parDim"  : <integer> valid values are 1,2,3,4
                  "degrees" : [<comma-separated list of integers>]
                  "ncoeffs" : [<comma-separated list of integers>]
                  "nknots"  : [<comma-separated list of integers>]
                  "coeffs"  : [[comma-separated list of lists of floats]
                  "knots"   : [[comma-separated list of lists of floats]
                }
       ```

       -   The attribute `coeffs` is stored as a list of lists with the inner list containing all coefficients in lexicographical order(i.e. with the first parametric dimension $\xi_1$ running quickest and the last parametric dimension $\xi_{\text{par}_\text{dim}}$ running slowest) and the outer list containing the coefficients of the different geometric dimensions. 
       
           __Example:__
           ```
           coeffs = [[x_1_1, x_2_1, ..., x_ncoeffs(1)_ncoeffs(2)],
                     ...,
                     [z_1_1, z_1_2, ..., z_ncoeffs(1)_ncoeffs(2)]]
           ```
           for a bivariate parametrization with coefficients in $\mathbb{R}^3$.

           Currently, the float values are stored as plain JSON string but it is planned to change to binary base64 encoding in the future.

       -   The attribute `knots` is stored as a list of lists with the inner list containing the univariate knot vectors and the outer list containing the different parametric dimensions. 
       
           __Example:__
           ```
           knots = [[k1_1, ..., k1_nknots[0]], 
                    ..., 
                    [kparDim_1, ..., kparDim_nknots[parDim]]]
           ```

           Currently, the float values are stored as plain JSON string but it is planned to change to binary base64 encoding in the future.
       
   -   More model types will be added

### 2.5 Get a specific attribute of a specific model

   _Client request_
   ```
   "request" : get/<session-id>/<model-id>/<attribute>
   ```
   The __attribute__ must be one of the supported attributes of the model type:

   -   `uniformBSpline` and `nonuniformBSpline`
       ```
       geoDim, parDim, degrees, ncoeffs, nknots, coeffs, knots
       ```

   _Server response_
   ```
   "status"  : 0
   "data"    : {...}
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```
   The __data__ will be formatted in the same format as in the _all_ __attribute__ case.

### 2.6 Update a specific attribute of a specific model

   _Client request_
   ```
   "request" : put/<session-id>/<model-id>/<attribute>
   ```
   Supported __attributes__:

   -   `uniformBSpline` and `nonuniformBSpline`
       ```
       "coeffs" : [[<comma-separated list of lists of floats>]]
       ```

   _Server response_
   ```
   "status"  : 0
   "data"    : {...}
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 2.7 Evaluate a specific model

   The __model-types__ `uniformBSpline` and `nonuniformBSpline` support the evaluation at discrete points in the parameter space

   _Client request_
   ```
   "request" : eval/<session-id>/<model-id>
   ```

   _Server response_
   ```
   "status"  : 0
   "data" : { 
              "coords" : [[<ist of lists of floats in lexicographical order>]]
              "values" : [<list of floats in lexicographical order>]
            }
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```

### 2.8 Refine a specific model

   The __model-types__ `uniformBSpline` and `nonuniformBSpline` support regular refinement

   _Client request_
   ```
   "request" : refine/<session-id>/<model-id>
   "data"    : {
                 [ "numRefine" : <integer> (default value is 1) ]
                 [ "dim"       : <integer> (default value is -1) ]
               }
   ```
   If no __data__ field is provided the default values are adopted.

   _Server response_
   ```
   "status"  : 0
   ```
   or
   ```
   "status"  : 1
   "reason"  : <string>
   ```