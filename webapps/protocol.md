# WebApp protocol

_Version: 0.9 (23-05-2023)_

## Table of content

1.  [Terminology](protocol.md#terminology)
2.  [Overview](protocol.md#overview)
3.  [Session commands](protocol.md#session-commands)
4.  [Model commands](protocol.md#model-commands)
5.  [Models](protocol.md#models)
6.  [Descriptors](protocol.md#descriptors)

## Terminology

- **Front-end** is the front-end application enabling interaction with the user. One or more front-end applications can be running at the same time on the same or on different devices and connecting to the same or different sessions running on the back-end.
- **Back-end** is the back-end application executing the requests. One or more back-end applications can be running at the same time on the same or on different devices provided they accept requests on different TCP port so that a client can connect to a specific back-end.
- **Session** is the 'scene' presented to one or more users. A back-end can run one or more sessions at the same time. Each session can be identified by its UUID. A front-end application can only connect to a single session at a time but multiple front-end applications can connect to the same session to enable collaborative design.
- **Model** is the blueprint of a particular type of physical model (e.g. Poisson's equation in 2d). It is realized as library that is loaded dynamically by the back-end application during startup. Each instance of a model blueprint can be customized (e.g., number of control knots per spatial direction) during its creation process. The list of available models is communicated when creating a new session or connecting to an existing one.
- **Instance** is a customized model instantiation running in a session. A session can contain one or more instances of the same or different models. Instances are identified by their number (integer value starting at 0 and being increased for each new instance that is created).
- **Component** is a part of a model, e.g., the geometry, the loadvector, or the solution field, that can be addressed individually. Components are separated into **inputs** and **outputs**. Inputs such as the geometry are components that can be modified by the user in the UI. Outputs such as the solution are fields that can be selected for visualization.

## Overview

All WebApps implement the following [WebSocket](https://en.wikipedia.org/wiki/WebSocket)-based client-server protocol. All communication is initiated by the client and responded by the server. Only broadcasts are initiated by the server and responded by all clients, e.g., when a client request leads to a state change of the server, then an update is broadcasted to all clients connected to the same session.

The format of the [JSON](https://en.wikipedia.org/wiki/JSON)-based protocol is as follows:

_Client request_

```
{
    "id"      : <UUID>,
    "request" : <command>[/<session-id>][/<token1>]...[/<tokenN>],
  [ "data"    : {...} ]
}
```

_Server response_

```
{
    "request" : <UUID>,
    "status"  : <integer>,
  [ "reason"  : <string> ],
  [ "data"    : {...} ]
}
```

*   `UUID` is chosen by the client for each new request and copied by the server in the reply. 

*   `request` encodes the actual `command`, optionally followed by one or more `tokens`

*   `status` is an integer from the following list of predefined integers:
    -  `0` : `success`
    -  `1` : `invalidRequest`
    -  `2` : `invalidCreateRequest`
    -  `3` : `invalidRemoveRequest`
    -  `4` : `invalidConnectRequest`
    -  `5` : `invalidDisconnectRequest`
    -  `6` : `invalidGetRequest`
    -  `7` : `invalidPutRequest`
    -  `8` : `invalidEvalRequest`
    -  `9` : `invalidRefineRequest`
    - `10` : `invalidLoadRequest`
    - `11` : `invalidSaveRequest`
    - `12` : `invalidImportRequest`
    - `13` : `invalidExportRequest`

*   `reason` is an optional string that contains human-readable information about a failed request. Successful requests with `status : 0` will not contain a `reason` field

*    `data` is an optional request/response-dependent payload

In what follows, only the non-generic parts of the protocol are specified in more detail. 

## Session commands

### Get a list of all active sessions

   _Client request_
   ```
   "request" : "get"
   ```

   _Server response_
   ```
   "status"  : success (0)
   "data"    : { "ids" : [<comma-separated list of session ids>] }
   ```
   or
   ```
   "status"  : invalidGetRequest (6)
   "reason"  : <string>
   ```

### Create a new session

   _Client request_
   ```
   "request" : "create/session"
   ```

   _Server response_
   ```
   "status"  : success (0)
   "data"    : { "id" : session-id,
                 "models" : [<comma-separated list of models>] }
   ```
   or
   ```
   "status"  : invalidCreateRequest (2)
   "reason"  : <string>
   ```
   -   The `session-id` is generated by the server and serves as authentification mechanism.
   -   The `models` list describes the models supported by the server. 
   
       -   Each list entry has the form
           ```
           { "name"        : <string>,
             "description" : <string>,
             "options"     : [<comma-separated list of options>],
             "inputs"      : [<comma-separated list of inputs>],
             "outputs"     : [<comma-separated list of outputs>] }
           ```
           The model's `name` is used for creating a specific type.
       -   Each entry in the `options` list has the form
           ```
           { "name"        : <string>,
             "description" : <string>,
             "type"        : <optiontype descriptor>,
             "value"       : <values>,
             "default"     : <default value>
             "uiid"        : <integer specifying the position in the UI> }
           ```
           This information can be used to generate UI elements dynamically based on the capabilities of the server. See [`optiontype descriptor`](protocol.md#optiontype-descriptor) for details.

           _Example:_
           ```
           { "name"        : "ncoeffs",
             "description" : "Number of coefficients",
             "type"        : [int,int],
             "value"       : [5,5],
             "default"     : [5,5],
             "uiid"        : 0 }
           ```
           or
           ```
           { "name"        : "init",
             "description" : "Initialization of the coefficients",
             "type"        : "select",
             "value"       : ["zeros", "ones", "linear", "random", "greville"],
             "default"     : 2,
             "uiid"        : 1 }
           ```

       -   Each entry in the `inputs` and `outputs` lists has the form
           ```
           { "name"        : <string>,
             "description" : <string>,
             "type"        : <iotype descriptor> }
           ```
           whereby the `iotype descriptor` must be one of the options given in

### Remove an existing session

   _Client request_
   ```
   "request" : "remove/<session-id>"
   ```

   _Server response_
   ```
   "status"  : success (0)
   ```
   or
   ```
   "status"  : invalidRemoveRequest (3)
   "reason"  : <string>
   ```

### Connect to an existing session

   _Client request_
   ```
   "request" : "connect/<session-id>"
   ```

   _Server response_
   ```
   "status"  : success (0)
   ```
   or
   ```
   "status"  : invalidConnectRequest (4)
   "reason"  : <string>
   ```

### Disconnect from an existing session

   _Client request_
   ```
   "request" : "disconnect/<session-id>"
   ```

   _Server response_
   ```
   "status"  : success (0)
   ```
   or
   ```
   "status"  : invalidDisconnectRequest (5)
   "reason"  : <string>
   ```

### Update all models of a session by data loaded from an XML file

   _Client request_
   ```
   {
      "id"      : <UUID>,
      "request" : importxml/<session-id>,
      "data"    : { "xml" : <xml string>}
   }
   ```

   _Server response_
   ```
   "status"  : success (0)
   ```
   or
   ```
   "status"  : invalidLoadRequest (10)
   "reason"  : <string>
   ```

   Note that the session must have all models created in a form compatible with the XML file. That is, no new models are created from the XML file but only the attributes of existing models are updated by the data read from the XML file. If the models are not compatible with the data in the XML file the request terminates with an `invalidLoadRequest` status.

### Save all models of a session into an XML file

   _Client request_
   ```
   {
      "id"      : <UUID>,
      "request" : savexml/<session-id>,
   }
   ```

   _Server response_
   ```
   "status"  : success (0)
   "data"    : { "xml" : <xml string>}
   ```
   or
   ```
   "status"  : invalidSaveRequest (11)
   "reason"  : <string>
   ```

## Model commands

### Get a list of all models of a specific session

   _Client request_
   ```
   "request" : "get/<session-id>"
   ```

   _Server response_
   ```
   "status"  : success (0)
   "data"    : { "ids" : [<comma-separated list of model ids>] }
   ```
   or
   ```
   "status"  : invalidGetRequest (6)
   "reason"  : <string>
   ```

### Create a new model

   _Client request_
   ```
   "request" : "create/<session-id>/<model-type>"
   "data"    : {...}
   ```

   The list of supported models is sent by the server upon creating a new session or connecting to an existing session. See [Create a new session](protocol.md#create-a-new-session) and [Models](protocol.md#models) for details.

   _Server response_
   ```
   "status"  : success (0)
   "data"    : { "id" : model-id }
   ```
   or
   ```
   "status"  : invalidCreateRequest (2)
   "reason"  : <string>
   ```

### Remove an existing model

   _Client request_
   ```
   "request" : "remove/<session-id>/<model-id>"
   ```

   _Server response_
   ```
   "status"  : success (0)
   ```
   or
   ```
   "status"  : invalidRemoveRequest (3)
   "reason"  : <string>
   ```

### Get all attributes of a specific model

   _Client request_
   ```
   "request" : "get/<session-id>/<model-id>"
   ```

   The attributes for the different models are given in [Models](protocol.md#models).

   _Server response_
   ```
   "status"  : success (0)
   "data"    : {...}
   ```
   or
   ```
   "status"  : invalidGetRequest (6)
   "reason"  : <string>
   ```

### Get a specific attribute of a specific model

   _Client request_
   ```
   "request" : "get/<session-id>/<model-id>/<attribute>"
   ```

   The attributes for the different models are given in [Models](protocol.md#models).

   _Server response_
   ```
   "status"  : success (0)
   "data"    : {...}
   ```
   or
   ```
   "status"  : invalidGetRequest (6)
   "reason"  : <string>
   ```
   The `data` will be formatted in the same format as in the _get all attributes_ case.

### Update a specific attribute of a specific model

   _Client request_
   ```
   "request" : "put/<session-id>/<model-id>/<attribute>"
   ```

   The updatable attributes for the different models are given in [Models](protocol.md#models).

   _Server response_
   ```
   "status"  : success (0)
   "data"    : {...}
   ```
   or
   ```
   "status"  : invalidPutRequest (7)
   "reason"  : <string>
   ```

### Evaluate a specific model

   _Client request_
   ```
   "request" : "eval/<session-id>/<model-id>/<output>"
   "data"    : {
                 "resolution" : [<list of integers]
               }
   ```
   The `output` must be one of the model's outputs (i.e. the `name` attribute) defined during [session creation](protocol.md#Create-a-new-session). 

   If the optional `data` and `resolution` are not present, the default resolution is 25 in each parametric dimension.

   _Server response_
   ```
   "status"  : success (0)
   "data" : { 
              "values" : [<list of floats in lexicographical order>]
            }
   ```
   or
   ```
   "status"  : invalidEvalRequest (8)
   "reason"  : <string>
   ```

### Refine a specific model

   _Client request_
   ```
   "request" : "refine/<session-id>/<model-id>"
   "data"    : {
                 [ "numRefine" : <integer> (default value is 1) ]
                 [ "dim"       : <integer> (default value is -1) ]
               }
   ```
   If no `data` field is provided the default values are adopted.

   _Server response_
   ```
   "status"  : success (0)
   ```
   or
   ```
   "status"  : invalidRefineRequest (9)
   "reason"  : <string>
   ```

## Models

### B-spline models

The following B-spline models are implemented:
-    `BSplineCurve` : uni-variate B-spline curve
-    `BSplineSurface` : bi-variate B-spline surface
-    `BSplineVolume` : tri-variate B-spline volume

#### B-spline model options

The following `data` can be passed during [model creation](protocol.md#Create-a-new-model):

```
"data" : { 
            "degree"     : <integer> valid values are 
                                     0 constant,
                                     1 linear (default),
                                     2 quadratic,
                                     3 cubic,
                                     4 quartic,
                                     5 quintic
            "init"       : <integer> valid values are 
                                     0 zeros,
                                     1 ones,
                                     2 linear (default),
                                     3 random,
                                     4 Greville
            "ncoeffs"    : [<comma-separated list of integers>]
                                     [4,...] (default)
            "nonuniform" : <bool>    valid values are
                                     0 uniform (default),
                                     1 nonuniform
         }
```

#### B-spline model attributes

The following `data` can be passed when [getting all model attributes](protocol.md#Get-all-attributes-of-a-specific-model) or [getting a specific model attribute](protocol.md#Get-a-specific-attribute-of-a-specific-model).
```
"data" : { 
            "geoDim"  : <integer>    valid values are 
                                     1 univariate,
                                     2 bivariate,
                                     3 trivariate,
                                     4 quadrupelvariate
            "parDim"  : <integer>    valid values are
                                     1 univariate,
                                     2 bivariate,
                                     3 trivariate,
                                     4 quadrupelvariate 
            "degrees" : [<comma-separated list of integers>]
            "ncoeffs" : [<comma-separated list of integers>]
            "nknots"  : [<comma-separated list of integers>]
            "coeffs"  : [[comma-separated list of lists of floats]]
            "knots"   : [[comma-separated list of lists of floats]]
         }
```

-   The attribute `coeffs` is stored as a list of lists with the inner list containing all coefficients in lexicographical order(i.e. with the first parametric dimension $\xi_1$ running quickest and the last parametric dimension $\xi_{\text{par}_\text{dim}}$ running slowest) and the outer list containing the coefficients of the different geometric dimensions. 
       
    __Example:__
    ```
    coeffs = [[x_1_1, x_2_1, ..., x_ncoeffs(1)_ncoeffs(2)], ...,
              [z_1_1, z_1_2, ..., z_ncoeffs(1)_ncoeffs(2)]]
    ```
    for a bivariate parametrization with coefficients in $\mathbb{R}^3$.

    Currently, the float values are stored as plain JSON string but it is planned to change to binary base64 encoding in the future.

-   The attribute `coeffs` can be modifief by the `put` command.

    __Example:__
    ```
    "request" : put/<session-id>/<model-id>/coeffs
    "data"    : {
                  "indices" : [0, 6, 9],
                  "coeffs"  : [[0.5, 0.2], [0.3, 0.6], [0.9, 1.2]]
                }
    ```
    This will update the coordinates of the two-dimensional coefficients with global indices `0`, `6`, and `9` to the values `[0.5, 0.2]`, `[0.3, 0.6]`, and `[0.9, 1.2]`. It is not assumed that the indices and coordinates are numbered.

-   The attribute `knots` is stored as a list of lists with the inner list containing the univariate knot vectors and the outer list containing the different parametric dimensions. 
       
    __Example:__
    ```
    knots = [[k1_1, ..., k1_nknots[0]], ..., 
             [kparDim_1, ..., kparDim_nknots[parDim]]]
    ```

    Currently, the float values are stored as plain JSON string but it is planned to change to binary base64 encoding in the future.

## Descriptors

### Option-type descriptor

The `optiontype descriptor` must be one of the following

| `type`        | description  | value format example | enum value |
|--------------:|:-------------|:---------------------|------------|
| `int`         | integer value| `"value" : 5` or     |
||| `"value" : [5,5]`  |
| `float`       | float value  | `"value" : 5.0` or  |
||| `"value" : [5.0,5.0]` |
| `string`      | string value | `"value" : "string"` or |
||| `"value" : ["string1","string2"]` |
| `list`    | can select no, one or multiple options | `"value" : { "option0", "option1" }`|
| `select` | must select one option  | `"value" : { "option0", "option1" }`|

Types `list` and `select` correspond to enumerators with the mapping `option0 -> 0`, `option1 -> 1` etc. It is therefore expected that if, say, `option1` is chosen in a `select` type, the UI sends the value `1` in the next request. Similarly, if, say, `options0` and `options1` are chosen in a `list` type, the UI sends the value `[0,1]` in the next request. 

### Input/output-type descriptor

The `iotype descriptor` must be one of the following

 | `type`        | description   | enum value |
 |--------------:|:--------------|------------|
 | `scalar`      | scalar value (e.g., error or drag/lift coefficient) | 0 |
 | `scalarfield` | scalar field (e.g., pressure) | 1 |
 | `vectorfield` | vector field (e.g., velocity) | 2 |
 | `scalarfield_boundary` | scalar field at the boundary (e.g., pressure boundary conditions) | 3 |
 | `vectorfield_boundary` | vector field at the boundary (e.g., velocity) | 4 |

 ### Capability descriptor

 The `capability descriptor` must be one of the following

 | `type`        | description   | enum value |
 |--------------:|:--------------|------------|
 | `eval`        | evaluate model| 0 |
 | `refine`      | refine model  | 1 |
 | `elevate`     | elevate model | 2 |
 | `load`        | load model from file | 101 |
 | `save`        | save model to file   | 102 |
 | `importXML`   | import object from XML file | 201 |
 | `exportXML`   | export object to XML file   | 202 |
---

# TODO

2. global translate and rotate parameter
